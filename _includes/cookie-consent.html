<!-- === Head: Consent Mode por defecto y bootstrap m칤nimo (coloca este bloque en <head> antes de cualquier otro script) === -->
<script>
  // dataLayer + gtag
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }

  // Google Consent Mode v2: todo denegado por defecto
  gtag('consent', 'default', {
    ad_storage: 'denied',
    analytics_storage: 'denied',
    ad_user_data: 'denied',
    ad_personalization: 'denied'
  });

  // Flags para controlar Clarity
  window.__CLARITY_ALLOWED__ = false;   // solo true tras "Accept"
  window.__clarityLoaded = false;       // evita cargas duplicadas

  // Carga condicional de Clarity: solo si hay consentimiento
  function loadClarity(){
    if (!window.__CLARITY_ALLOWED__ || window.__clarityLoaded) return;
    // Stub de cola antes de cargar el script real (no env칤a datos por s칤 mismo)
    window.clarity = window.clarity || function(){ (window.clarity.q = window.clarity.q || []).push(arguments); };

    // Se침al de consentimiento para Clarity antes de cargar el tag
    window.clarity('consentv2', { ad_Storage: 'granted', analytics_Storage: 'granted' });

    // Inserta el tag de Clarity
    if (document.getElementById('clarity-loader')) { window.__clarityLoaded = true; return; }
    var sCl = document.createElement('script');
    sCl.id = 'clarity-loader';
    sCl.async = true;
    sCl.src = 'https://www.clarity.ms/tag/odc6tt5gf3';
    sCl.onload = function(){ window.__clarityLoaded = true; };
    document.head.appendChild(sCl);
  }
</script>

<style>
  /* Existing CSS styles */
  #cookie-notice {
      font-weight: 900;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      display: none;
      text-align: center;
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #222;
      color: rgba(255, 255, 255, 0.8);
      z-index: 9000;
      border-top: 2px solid #00a8ff;
      box-shadow: 0px -3px 5px rgba(0, 0, 0, 0.3);
  }
  #cookie-notice a { color:#00a8ff; margin-left:1rem; font-weight:600; }
  #cookie-notice .btn {
      background-color:#00a8ff; border:none; color:#fff; padding:.5rem 1rem;
      text-transform:uppercase; cursor:pointer; margin-left:1rem; border-radius:4px;
  }
  #cookie-notice .btn:hover { background-color:#0073b1; }
  @media (max-width:767px){
      #cookie-notice{ padding:1rem; }
      #cookie-notice span{ display:block; margin-bottom:10px; }
      #cookie-notice .btn{ display:inline-block; margin:5px 0; }
  }
  #cookie-toggle{
      position:fixed; bottom:20px; right:15px; font-size:32px; cursor:pointer;
      z-index:9001; display:none; background:none; border:none;
  }
</style>

<!-- Cookie Policy Banner -->
<div id="cookie-notice">
  <span>We use cookies to enhance your experience. <a href="/privacy-policy/">Privacy Policy</a></span>
  <a id="cookie-notice-accept" class="btn btn-primary btn-sm">Accept</a>
  <a id="cookie-notice-decline" class="btn btn-primary btn-sm">Decline</a>
</div>
<button id="cookie-toggle">游꼵</button>

<script>
  // -------- Utilidades de cookies --------
  function createCookie(name, value, days){
    var expires = "";
    if (days){
      var d = new Date();
      d.setTime(d.getTime() + (days*24*60*60*1000));
      expires = "; expires=" + d.toUTCString();
    }
    document.cookie = name + "=" + value + expires + "; path=/; SameSite=Lax";
  }
  function readCookie(name){
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for (var i=0; i<ca.length; i++){
      var c = ca[i];
      while (c.charAt(0) == ' ') c = c.substring(1,c.length);
      if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
  }

  // -------- GA4 solo tras consentimiento --------
  function loadGA(){
    if (document.getElementById('ga4-loader')) return;
    var sGA = document.createElement('script');
    sGA.id = 'ga4-loader';
    sGA.src = 'https://www.googletagmanager.com/gtag/js?id=G-0JC8WREF2K';
    sGA.async = true;
    document.head.appendChild(sGA);
    sGA.onload = function(){
      gtag('js', new Date());
      gtag('config', 'G-0JC8WREF2K');
    };
  }

  // -------- Gesti칩n de consentimiento --------
  function grantConsent(){
    // Google Consent Mode v2
    gtag('consent', 'update', {
      ad_storage: 'granted',
      analytics_storage: 'granted',
      ad_user_data: 'granted',
      ad_personalization: 'granted'
    });

    // Permite cargar Clarity y l치nzalo
    window.__CLARITY_ALLOWED__ = true;
    loadClarity();
  }

  function denyConsent(){
    // Google Consent Mode v2
    gtag('consent', 'update', {
      ad_storage: 'denied',
      analytics_storage: 'denied',
      ad_user_data: 'denied',
      ad_personalization: 'denied'
    });

    // Si Clarity ya estaba cargado de una aceptaci칩n previa, corta su actividad
    if (window.__clarityLoaded && typeof window.clarity === 'function'){
      try { window.clarity('consentv2', { ad_Storage:'denied', analytics_Storage:'denied' }); } catch(e){}
      // Recargar garantiza que no se vuelva a cargar Clarity
      location.reload();
    }
    window.__CLARITY_ALLOWED__ = false;
  }

  // -------- Estado inicial --------
  (function initConsentUI(){
    var choice = readCookie('cookie-notice-dismissed');
    var banner = document.getElementById('cookie-notice');
    var toggle = document.getElementById('cookie-toggle');

    if (choice === 'true'){
      toggle.style.display = 'block';
      grantConsent();
      loadGA();
    } else if (choice === 'false'){
      toggle.style.display = 'block';
      // Mantener todo bloqueado y mostrar el banner si quieres re-pedir
      banner.style.display = 'block';
    } else {
      // Usuario nuevo
      banner.style.display = 'block';
    }
  })();

  // -------- Eventos --------
  document.getElementById('cookie-notice-accept').addEventListener('click', function(){
    createCookie('cookie-notice-dismissed', 'true', 31);
    document.getElementById('cookie-notice').style.display = 'none';
    document.getElementById('cookie-toggle').style.display = 'block';
    grantConsent();
    loadGA();
  });

  document.getElementById('cookie-notice-decline').addEventListener('click', function(){
    var wasTrue = readCookie('cookie-notice-dismissed') === 'true';
    createCookie('cookie-notice-dismissed', 'false', 31);
    document.getElementById('cookie-notice').style.display = 'none';
    document.getElementById('cookie-toggle').style.display = 'block';
    if (wasTrue){
      // Revocaci칩n: pasa a denegado y recarga para cortar scripts activos
      denyConsent();
    } else {
      // Primer rechazo: simplemente mant칠n denegado
      denyConsent();
    }
  });

  document.getElementById('cookie-toggle').addEventListener('click', function(){
    document.getElementById('cookie-notice').style.display = 'block';
    document.getElementById('cookie-toggle').style.display = 'none';
  });
</script>
